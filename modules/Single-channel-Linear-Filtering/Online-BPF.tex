\chapterp{3p}{Current online SWR detection}\label{ch:BPF}

This chapter discusses the current state-of-the-art method in online SWR detection. This method is very similar to the procedure for offline ripple detection described in \cref{ch:offline}: a single recording channel that contains ripples is selected; it is band-pass filtered through the ripple band; and apply a detection threshold is applied to the envelope of the filter output.
% todo: multi-channel (Dutta, Ciliberti)

The difference is that the SWR detection must now happen under real-time constraints. No future samples can be used when deciding whether the current recording sample belongs to an SWR event. This means that the used band-pass filter (and in some studies, also the envelope estimation method) must necessarily introduce latency.

We first discuss the performance of the online band-pass filters used in the literature, and then shortly discuss online estimation of the filter output envelope.



% \section{Online band-pass filters}
\section{Replicating existing filters}

We selected three existing online ripple filters and analyzed their performance. The first two filters are described in the literature. (We gathered a representative sample of original research papers that use online ripple detection -- see \cref{apx:online-detection-algos}. Most of these papers do not provide sufficient information to replicate the used filter. The two selected filters are from the two papers that did provide sufficient information.)
The third analyzed filter is the default online ripple filter in \emph{Falcon}. (\emph{`Falcon'} is an open-source software package for closed-loop neuroscience, developed and used in the Kloosterman lab, and described in \citefull{Ciliberti2017}).

The existing filters use different passbands and sampling frequencies. When we `replicate' the original filters to apply them to our data, we use a standardized sampling frequency $f_s$ of 1000 Hz. When designing the replica filters, we try to match the gain- and group delay-profiles of the original filters.


\subsection{\authoryear{Ego-Stengel2009}}

In one of the first ripple disruption studies \cite{Ego-Stengel2009}, an analog band-pass filter is used. An 8th-order Butterworth high-pass filter at 100 Hz is combined with an 8th-order Butterworth low-pass filter at 400 Hz.
We approximate this continuos-time filter by the product of two discrete-time Butterworth filters at $f_s = 1000$ Hz: an 8th-order high-pass filter at 100 Hz, and a 2nd-order low-pass filter at 400 Hz. Its frequency response is compared with that of the original filter in \cref{fig:ego-stengel}.\footnote{Note that we do not choose the literal discretization of the continuous-time filter (namely the combination of an 8th-order high-pass and an 8th-order low-pass Butterworth filter). Around 400 Hz, this discretization has too high a peak in group delay and too steep a loss in gain for its frequency response profiles to match the original filter well.}

\begin{figure}
\img{EgoStengel}
\captionn{Online ripple filter from \authoryear{Ego-Stengel2009}}
{The group delay of each filter is calculated as $-\dv*{\phi}{f}$, where $\phi$ is the unwrapped phase response of the filter. (The derivative is calculated numerically using a Savitsky-Golay filter, with 5 samples per window, $\Delta f \approx 0.05$ Hz, and cubic polynomials). This method is also used for following group delay plots.}
\label{fig:ego-stengel}
\end{figure}


\subsection{\authoryear{Dutta2018}}

In this recent analysis of an online ripple detection system \cite{Dutta2018}, a 30-tap FIR filter at $f_s = 3000$ Hz is used. In the open source code of this study\footnote{\url{https://github.com/shayokdutta/RippleDetectionAnalysis/blob/master/DataAnalysisScripts/ripple_filtering.py}}, we find that the filter is designed using the windowed-sinc method, with a Hamming window. We approximate this filter at a sampling frequency of 1000 Hz with an 11-tap FIR filter, designed using the same method, window type, and passband. The correspondence is good (see \cref{fig:dutta}). Note the low attenuation outside the passband, and the constant, relatively low group-delay.

\begin{figure}
\img{Dutta}
\captionn{Online ripple filter from \authoryear{Dutta2018}}{}
\label{fig:dutta}
\end{figure}


\subsection{Falcon (\authoryear{Ciliberti2017})}

The default ripple filter in \emph{Falcon} is a Type II Chebyshev filter, with a passband of $\approx$ 130--280 Hz, a minimum attenuation in the stopbands of 40 dB, and a maximum attenuation in the passband of 1 dB. The original filter operates on data with a sampling rate of 32 kHz. We can closely approximate this filter at $f_s = 1000$ Hz using a 10th-order (21-taps) Type II Chebyshev filter, with the same design parameters. Its frequency response is shown in \cref{fig:falcon}. Note the trade-off between filter quality and group delay apparent in these and the previous filters: sharp passband edges correspond to high group delays, and vice-versa.

\begin{figure}
\img{Falcon}
\captionn{Default online ripple filter in Falcon}{}
\label{fig:falcon}
\end{figure}


% continue: output envelope (small & wider t-range?)

% continue: PR-curves of all four (Ego-Stengel, Dutta, Falcon, best-BPF)

% continue: paste-in and reference online BPF searcharrays.



\section{Online envelope estimation}

The real-time constraint also means that we can no longer use the Hilbert transform to calculate the envelope $n_t$ of the band-pass filter output $o_t$. In practice, the band-pass filter output is often simply rectified (i.e. $n_t = \abs{o_t}$).
% Although the resulting jagged signal is not as visually pleasing as the Hilbert-transform based envelope, it is effective for signal detection.
% (In \citefull{Sethi2014}, it was shown that more advanced online envelope estimators do not yield better detection performance).

Extensions of simple rectification have also been used. In \citefull{Jadhav2012}, the online envelope $n_t$ is an exponentially weighted moving average (EWMA) of $\abs{o_t}$. They use a slightly higher weight for $\abs{o_t}$  whenever $n_t < \abs{o_t}$ (see \cref{apx:online-detection-algos}. In \citefull{Dutta2018}, $\abs{o_t}$ is smoothed with a 50 Hz low-pass FIR filter.

Both methods add latency. The EWMA method of \citeauthor*{Jadhav2012} delayed the envelope by about 2 milliseconds when applied to our recording. The FIR low-pass filter of \citeauthor*{Dutta2018} has a constant group delay of about 5 milliseconds.

Smoothing $\abs{o_t}$ yields a visually more pleasing envelope. This is not a requirement for online SWR detectors however. Because smoothing adds latency, we do not smooth our online envelopes; all online envelopes in this thesis are calculated as $n_t = \abs{o_t}$.




% task: what's used in online SWR-detection literature.

% task: for each filter, a separate plot (in appendix) of its parameter range (rp, rs, width). DONE
% task: a plot of groupdelay in ripple band, and ratio of sumated magnitude responses passband versus stopband. DONE

% task: write about difference in fs (and therefore normalized frequencies & numtaps)

% Goal of this chapter:
%  - Establish baseline, implement SOTA
%  - Find best digital online BPF.

% Idea: implement Ego-Stengel (cont2discrete(butter)), Jadhav (best IIR), Talakoub / Dutta (FIR). With simple abs.
% OR: find equivalent of these in your already existing graphs. Annotate them (with thick dot and arrow).
%   Decision here: each study has different band.
%   (100-400, 100-400, 80-150, 150-250).
%   Let's plot both.


\clearpage
\begin{figure}
\img{searcharray-cheby2}
\captionn[, ]{Performance of Chebyshev type 2 IIR-filters}{for different filter orders. The minimum stop-band attenuation was set to 40 dB.}
\end{figure}

\begin{figure}
\img{searcharray-butter}
\captionn[, ]{Performance of Butterworth IIR-filters}{for different filter orders.}
\end{figure}
