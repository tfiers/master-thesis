\chapter{SWR detection in the literature}

We gathered a representative sample of research papers that discuss sharp wave-ripples (and/or other hippocampal oscillations). Different studies define these oscillations with different frequency bands -- these differences are listed in \cref{tab:bands}. \Cref{apx:offline-detection-algos,apx:online-detection-algos} quote papers that use SWR detection; specifically their description of the SWR detection procedure. Emphasis is added.


\begin{table}
\begin{tabular}{@{}lllll@{}}
\toprule
Source                     & Theta (Hz) & High gamma (Hz) & Ripple (Hz)  \\
\midrule
\citefull{Nadasdy1999}     &            &                 & 150 -- 250  \\
\citefull{Csicsvari2000}   &            &                 &  80 -- 250  \\
\citefull{Behrens2005}     &            &                 &  40 -- 400  \\
\citefull{OKeefe2007}      & 6 -- 12    & 30 -- 100       & 100 -- 200  \\
\citefull{Girardeau2009}   &            &                 & 100 -- 200  \\
\citefull{Ego-Stengel2009} &            &                 & 100 -- 400  \\
\citefull{Jadhav2012}, online &         &                 & 100 -- 400  \\
\citefull{Jadhav2012}, offline &        &                 & 150 -- 250  \\
\citefull{Buzsaki2015}     & 6 -- 10    & 100+            & 110 -- 200  \\
\citefull{Colgin2016}      & 6 -- 12    & 60 -- 100       & 150 -- 200  \\
\citefull{Sadowski2016}    &            &                 & 120 -- 250  \\
\citefull{Talakoub2016}    &            &                 &  80 -- 150  \\
\citefull{Eichenbaum2017}  & 4 -- 12    & 80 -- 140       & \\
\citefull{Dutta2018}       &            &                 & 150 -- 250  \\
\citefull{Olafsdottir2018} & 6 -- 12    &                 & 140 -- 250  \\
\midrule
\texttt{fklab}             & 6 -- 12    & 60 -- 140       & 140 -- 225  \\
L2 recording               & 5 -- 10    &                 & 100 -- 200  \\
\bottomrule
\end{tabular}
\captionn[, ]{Frequency bands of hippocampal LFP events}{according to different sources (both original research papers and literature reviews). When the source does not make a distinction between high and low gamma, the full gamma range is given. Note that \citeauthor*{Behrens2005} considered artificially induced SWR's in ex-vivo hippocampus slices. \Citeauthor*{Talakoub2016} studied macaque monkeys; other primary research papers studied rats. `\texttt{fklab}' refers to the default frequency bands used in the data-analysis software used in the Kloosterman lab. The last row refers to the dataset analysed in this thesis.}
\label{tab:bands}
\end{table}





\clearpage
\section{Offline detection algorithms}
\label{apx:offline-detection-algos}



\subsection{\authoryear{Nadasdy1999}}

\begin{quotebar}
``For the extraction of sharp-wave (SPW) ripple events during sleep, the wide-band recorded data were bandpass filtered digitally (\textbf{150–250 Hz}). The power (\textbf{root mean square}) of the filtered signal was calculated, and the beginning, peak, and end of individual ripple episodes were determined. The threshold for ripple detection was set to \textbf{7 SDs above the background mean} power (Csicsvari et al., 1999 \cite{Csicsvari1999}).'' \cite{Nadasdy1999}
\end{quotebar}


\subsection{\authoryear{Csicsvari2000}}

\begin{quotebar}
``\emph{Detection of SPW-Associated Fast Ripples}: The procedures described here were identical to those described earlier (Csicsvari et al., 1999b \cite{Csicsvari1999a}). The wide-band (1–5 kHz) recorded data was digitally band-pass filtered (\textbf{80–250 Hz}), and the power (\textbf{root-mean-square}) of the filtered signal was calculated for each electrode. The mean and standard deviation (SD) of the power signal were calculated to determine the detection threshold. Oscillatory epochs with a power of \textbf{one} or more \textbf{SD above the mean} were detected. The beginning and the end of oscillatory epochs were marked at points where the power fell below \textbf{0.5 SD}. Theta periods, detected by using the theta-delta power ratio (Csicsvari et al., 1999a \cite{Csicsvari1999}), were excluded from the analysis.'' \cite{Csicsvari2000}
\end{quotebar}


\subsection{\authoryear{Behrens2005}}

\begin{quotebar}
``For ripple detection, raw data were filtered with a Spike 2 software band-pass filter of \textbf{40--400 Hz} (threshold: \textbf{4--6} times the s.d. of \textbf{eventless baseline noise}). For sharp wave detection, recordings were low-pass filtered at 20 Hz.'' \cite{Behrens2005}
\end{quotebar}


\subsection{\authoryear{Girardeau2009}}

\begin{quotebar}
``Offline ripple detection was performed by band-pass filtering (\textbf{100--200 Hz}), \textbf{squaring and normalizing}, then thresholding the field potential recorded in CA1 pyramidal layer. Ripples were defined as events peaking at \textbf{>5 standard deviations} and lasting \textbf{<100 ms}.'' \cite{Girardeau2009}
\end{quotebar}


\subsection{\authoryear{Jadhav2012}}

\begin{quotebar}
``SWRs were detected during post-hoc analysis as described previously (11, 23). Raw LFPs recorded from the tetrodes used for online SWR detection were filtered between \textbf{150 – 250 Hz} and the SWR envelope was determined using a \textbf{Hilbert transform}. The envelope was \textbf{smoothed with a Gaussian with a s.d. of 4 ms and a width of 32 ms}. SWRs were defined as contiguous periods when the smoothed SWR envelope stayed \textbf{above 3 s.d.} of the mean [sic] for \textbf{at least 15 ms} on at least one tetrode.'' \cite{Jadhav2012}
\end{quotebar}


\subsection{\authoryear{Sadowski2016}}

\begin{quotebar}
``Ripples were detected offline in the LFP recorded on one CA1 channel. Raw LFP signal was filtered between \textbf{120 and 250 Hz}, and deflections in the ripple \textbf{power envelope} greater than \textbf{5 SDs from the mean} were classified as ripple events. Ripple start times were defined locally as when ripple power exceeded \textbf{2 SDs}. Samples of raw LFP and detected ripple times were compared manually to verify detection fidelity.'' \cite{Sadowski2016}
\end{quotebar}


\subsection{\authoryear{Dutta2018}}

\begin{quotebar}
``Post-recording, ripple events were defined on tetrodes that displayed characteristics of the CA1 area of the hippocampus. Specifically, the recorded LFP in one of the channels of the selected tetrode (same one subject to online detection for our realtime analysis) first had a digital reference subtracted away. This signal was then LFP band filtered with a 400 Hz low-pass infinite impulse response (IIR) filter (from Trodes). Afterwards the signal was decimated and ripple band filtered (\textbf{150–250 Hz}) with a \textbf{25 tap} finite impulse response (\textbf{FIR}) filter. Ripple band filtering was done using a forward and a time-reversed path, resulting in a net \textbf{zero group delay} (time shift from filtering). The instantaneous power of the ripple band filtered signal was then calculated via a \textbf{Hilbert Transform} and further \textbf{smoothened with a Gaussian kernel} with a \textbf{4 ms standard deviation}. Ripple events were detected as times when z-score of the smoothened power signal signal exceeded a threshold of \textbf{3 z-units} for \textbf{at least 15 ms}. The canonical ripple epochs were defined as the time points from which the processed signal \textbf{returned down to the mean before and after threshold crossings} \cite{Cheng2008,Kemere2013}.

In cases when multiple electrodes (typically channels on different tetrodes) are available for ripple detection, a different canonical definition is required. Ripples were initially defined using as above for each electrode. A canonical multichannel ripple was defined as one which is simultaneously detected on each electrode (two in our analysis). The multichannel ripple epoch is defined as the union of the detected single-channel ripple epochs, i.e., the start of the earliest ripple detected and to end with bound of last ripple detected. As such, we obtain a conservative ripple detection latency estimate while covering the entire span of the time the LFP is in a high ripple band power state. We reanalyzed our data with the canonical ripples being defined on different channels and tetrodes with a 300 tap bandpass FIR filter allowing 1\% “ripple” in the passband with -30 dB suppression in the stopband but our results and subsequent conclusions remained consistent.'' \cite{Dutta2018}
\end{quotebar}





\clearpage
\section{Online detection algorithms}
\label{apx:online-detection-algos}

For each of the quoted studies, we attempt to approximate the described band-pass filter. Different studies use different passbands and sampling frequencies. For our `replication' filters, we use a standardized passband (100--200 Hz) and sampling frequency (1000 Hz). We then try to match the gain- and group delay-profiles of the original filter (rescaled to the standardized passband) when designing our replication filters.


\subsection{\authoryear{Girardeau2009}}

\begin{quotebar}
``The onset of SPW-Rs was detected online by filtering the signal in the ripple-band and thresholding it. [..] Brain signals were preamplified (..), acquired and \textbf{digitized} using two synchronized Power1401 systems (CED, Cambridge, UK). [..] In both cases (test and control) the number of stimulations was \textbf{limited to 5 per second}.'' \cite{Girardeau2009}
\end{quotebar}

No information on the online band-pass filter is given (although we might deduce that the pass-band was 100--200 Hz, from \cref{apx:offline-detection-algos}). We therefore do not include this study in any baseline comparisons.


\subsection{\authoryear{Ego-Stengel2009}}

\begin{quotebar}
``We selected one tetrode in CA1, for which the LFP signal exhibited ripple events of large amplitude, for online ripple detection. The LFP was amplified and filtered online in the ripple band by an \textbf{8th-order Butterworth lowpass filter at 400 Hz} followed by an \textbf{8th-order Butterworth highpass filter at 100 Hz} (KrohnHite 3384 analog filters, total gain 10,000). A threshold-crossing detector (FHC Window Discriminator) was used to generate TTL pulses when the ripple amplitude exceeded a value adjusted manually by the experimenter on the first experimental day for each rat (0.1 $\pm$ 0.02 mV). These pulses triggered isolated stimulation units via a computer- controlled burst generator with a preset 1-ms delay [..] A \textbf{2-s recovery period} was forced after any stimulation burst before the next stimulation could be triggered.'' \cite{Ego-Stengel2009}
\end{quotebar}

We approximate the analog filter of this study by the product of two digital Butterworth filters: a 6th-order high-pass filter at 100 Hz, and a 3th-order low-pass filter at 200 Hz. See \cref{fig:ego-stengel}.

\begin{figure}
\img{ego-stengel}
\captionn{Online BPF from \authoryear{Ego-Stengel2009}}{\newline
Blue: continuous-time band-pass filter as described in the original research paper (product of analog low- and high-pass 8th-order Butterworth filters).\newline
Orange: discrete-time approximation of the original filter, for a passband of 100--200 Hz and a sampling frequency of 1000 Hz.}
\label{fig:ego-stengel}
\end{figure}


\subsection{\authoryear{Jadhav2012}}

\begin{quotebar}
``We disrupted awake hippocampal SWRs [..] with the use of an online feedback system similar to that used in previous studies that disrupted SWRs during post-behavior sleep \cite{Girardeau2009,Ego-Stengel2009}. SWRs in CA1 were detected by monitoring power in the ripple band simultaneously across multiple tetrodes. [..] This [detection-triggered stimulation] terminated the ripple oscillation \textbf{within 25 ms of SWR onset} and transiently inhibited CA1 spiking [..].\\
We recorded continuous local field potentials (LFP, filtered 0.5-400 Hz and sampled at 1500 Hz) from all tetrodes (one channel was chosen from each tetrode for LFP recording). [..]\\
\emph{Real-time detection algorithm}. Field potential signals from the 5-6 tetrodes chosen for online detection were broadly filtered in the ripple band (\textbf{20 tap band-pass IIR filter, 100-400 Hz}). In order to establish a disruption threshold, we calculated smoothed values of the mean and s.d. of the absolute value of the filtered LFP signal on each tetrode being used for detection using an iterative procedure:\footnote{Equations rearranged for readability, and variable names substituted to match those used in this thesis. Note that $\mu\est$ and $\sigma\est$ are exponentially weighted moving averages of respectively $\abs{o}$ and $\abs{\abs{o} - \mu\est}$. }
\begin{align*}
\mu\est_t &= \mu\est_{t-1} \ \frac{N\smooth - 1}{N\smooth}
                + \frac{\abs{o_t}}{N\smooth} \\
\sigma\est_t &= \sigma\est_{t-1} \ \frac{N\smooth - 1}{N\smooth}
                + \frac{\abs{\abs{o_t} - \mu\est_{t-1}}}{N\smooth}
\end{align*}
Here $\mu\est$ and $\sigma\est$ are the estimated mean and s.d. of the absolute value of the filtered LFP, $o$, and $N\smooth$ is the  number of samples for smoothing (typically 10000). We allowed these estimates to stabilize before each run session. To generate a smoothened estimate of the envelope ($n\est$) of the filtered LFP, we used the following iterative estimator:\footnote{Like $\mu\est$, $n\est$ is also an exponentially weighted moving average of $\abs{o}$, but with a much larger weight for the most recent value of $\abs{o}$. Testing the estimator of \citeauthor*{Jadhav2012} on our data, we find a weight $g$ that oscilates between 0.2 and values between 0.27 and 0.30.}
\[
n\est_t = (1 - g_{t-1}) n\est_{t-1} + g_{t-1} \abs{o_t}
\]
To allow for rapid detection of increases in power, we used a larger gain $g$ for periods when the envelope was increasing: when the envelope was decreasing ($\abs{o} \le n\est$), $g = 0.2$ when the envelope was increasing, we used a moving average of the last 19 [sic] values of $g$ and $1.2$:
\[
g_t = 
\begin{cases}
    0.2,    & \text{if}\quad n\est_{t-1} \geq \abs{o} \\
    \ev{g_{t-20}, g_{t-19}, \tdots, g_{t-1}, 1.2},  & \text{otherwise}
\end{cases}
\]

The threshold for disruption was set to \textbf{4-6 s.d.\ above the mean}. To prevent false-positives, vHC stimulation was triggered only when the smoothed LFP envelope exceeded threshold on at least 2 tetrodes. Stimulation rate was limited to a maximum of 4 Hz by enforcing a \textbf{lock-out period of 250 ms} after each stimulation event.'' \cite{Jadhav2012}
\end{quotebar}


\subsection{\authoryear{Talakoub2016}}

\begin{quotebar}
``Local field potentials were [..] sampled at \textbf{32 kHz}. [..] Selecting the electrode channel with the highest-amplitude ripple activity [..].  In this study, we set the threshold to \textbf{6-sd} of the band activity, a value similar to rodent interruption studies. The 6-sd threshold was estimated based on the average and variance of the ripple band from earlier recordings which were consistent over days in these experiments (9.5 $\pm$ 0.1 \uV{} mean $\pm$ SEM).\newline
[..] the signals were bandpass filtered using a custom-designed finite impulse response (\textbf{FIR}) filter with \textbf{512 taps} (\textbf{16 ms delay}, which is about one cycle of ripple activity).\footnotemark{} Activities slower than \textbf{80 Hz} or faster than \textbf{150 Hz} are suppressed more than 20 dB (Fig. [..]). '' \cite{Talakoub2016}
\end{quotebar}

\footnotetext{An FIR filter has a constant group delay of $(\text{\# taps} - 1) / (2 f_s)$. A 512 tap FIR filter at $f_s = $ 32 kHz should therefore have a group delay of 8 ms (and not the reported 16 ms). Or, conversely, an FIR filter with a group delay of 16 ms should have $\approx$ 1024 taps at $f_s = $ 32 kHz (and not the reported 512 taps).}


\subsection{\authoryear{Dutta2018}}

\begin{quotebar}
``Like our canonical ripple detections, the realtime or online detection algorithm is comprised of single channel and multichannel modalities. The single channel case performs realtime reference subtraction from the LFP (filtered in the same way as the offline case) and \textbf{decimation from 30 kHz to 3 kHz} as in the canonical detection case. However, the difference between online and canonical detections begins from ripple band filtering. The decimated signal is \textbf{filtered to the ripple band with a 30 tap FIR filter}.\footnotemark{} In order to perform a realtime instantaneous power estimation and smoothing, the realtime algorithm computes the \textbf{absolute value of the ripple band filtered signal} and \textbf{further filters it by a 33 tap 50 Hz low-pass FIR} (instead of a Hilbert transform followed by Gaussian kernel smoothing). These filters cause an intrinsic sample delay from the offline case ($\approx$10.167 ms in our case). It is worth noting that the number of filter taps as well as filter types were determined by analyzing algorithmic delay and detection accuracy based on metrics described in the Data Analysis subsection. To normalize detection thresholds in the realtime case, the mean and standard deviation of the smoothed envelope are estimated over a 20 minute training period. In two $\approx$90 minute sleep box recording sessions, when we sampled 20 minute time intervals at random (N=1000), the resulting mean and standard deviation were within 5\% of the values for the entire sessions. This length of time and subsequent error in parameter estimation likely depends on the behavioral and/or sleep state of the animal — in our experimental recordings, animals were contained in a sleep box. realtime detections are then triggered when the envelope crosses a threshold defined as α standard deviations above the mean (threshold = $\alpha \cdot \sigma + \mu$) or $\alpha$ z-units. Following a detection, there is a \textbf{200 ms lockout period} where we ignore any further threshold crossings (i.e., to avoid stimulation artifacts). \textbf{Additionally}, we impose a hard \textbf{limit on the number of detections per second} (set to \textbf{three} during the experiments in this work).'' \cite{Dutta2018}
\end{quotebar}

\footnotetext{By reading the open source code from this paper (\url{https://github.com/shayokdutta/RippleDetectionAnalysis/blob/master/DataAnalysisScripts/ripple_filtering.py}), this 30-tap FIR filter was determined to be designed using the windowed-sinc method, with a Hamming window.}

% Group delay = 14.5 / 3 + 16 / 3 = 10.167  [check].
%
% What's a good sampling frequency to work at?
%   Higher fs: filters need more delays, but one delay is < ms
%   Does this cancel out, or is there an optimal fs?
